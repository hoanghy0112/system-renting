# ================================
# DistributedCompute - Production Overrides
# ================================
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# ================================

services:
  backend:
    build:
      context: .
      dockerfile: apps/backend/Dockerfile
      # target: runner  # Use production stage
    container_name: distributed-compute-backend-prod
    environment:
      NODE_ENV: production
      # Override with production values via .env file
      DATABASE_URL: ${DATABASE_URL}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      INFLUXDB_URL: http://influxdb:8086
      INFLUXDB_TOKEN: ${INFLUXDB_TOKEN}
      INFLUXDB_ORG: ${INFLUXDB_ORG}
      INFLUXDB_BUCKET: ${INFLUXDB_BUCKET}
      CLERK_SECRET_KEY: ${CLERK_SECRET_KEY}
      CLERK_PUBLISHABLE_KEY: ${CLERK_PUBLISHABLE_KEY}
      FRP_SERVER_ADDR: frps
      FRP_SERVER_PORT: 7000
      FRP_AUTH_TOKEN: ${FRP_AUTH_TOKEN}
      FRP_PORT_RANGE_START: 10000
      FRP_PORT_RANGE_END: 10100
    volumes: []  # No source mounting in production
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

  postgres:
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

  influxdb:
    environment:
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUXDB_ADMIN_PASSWORD}
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${INFLUXDB_TOKEN}
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G

  redis:
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  frps:
    volumes:
      - ./config/frps.prod.toml:/etc/frp/frps.toml:ro
